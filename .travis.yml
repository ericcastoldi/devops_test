language: go


go:
  - 1.19

stages:
  - Tests
  - Build
  - Plan

jobs:
  include:
    - stage: Tests
      script: 
        - go test --cover -v
    - stage: Build
      script:
        - go mod download
        - go build -v -o get-ninjas-api
    - name: Build And Push Image
      script:
        - echo $DOCKERHUB_PASS | docker login --username $DOCKERHUB_USER --password-stdin
        - docker build --tag "$DOCKERHUB_USER/get-ninjas-api" .
        - docker push "$DOCKERHUB_USER/get-ninjas-api:latest"
      include:
    - stage: Plan
      env:
        - tf_version=1.1.4 tf_init_cli_options="-input=false" tf_validation_cli_options="" tf_plan_cli_options="-lock=false -input=false" tf_apply_cli_options="-auto-approve -input=false"
      script:
        - cd terraform
        - wget https://releases.hashicorp.com/terraform/"$tf_version"/terraform_"$tf_version"_linux_amd64.zip
        - unzip terraform_"$tf_version"_linux_amd64.zip
        - sudo mv terraform /usr/local/bin/
        - rm terraform_"$tf_version"_linux_amd64.zip
        - terraform init $tf_init_cli_options
        - terraform validate $tf_validation_cli_options
        - terraform plan $tf_plan_cli_options
        - terraform apply -auto-approve

