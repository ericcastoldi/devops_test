language: go


go:
  - 1.19

stages:
  - Tests
  - Build
  - Terraform

jobs:
  include:
    - stage: Tests
      script: 
        - go test --cover -v
    - stage: Build
      script:
        - go mod download
        - go build -v -o get-ninjas-api
    - name: Build And Push Image
      script:
        - echo $DOCKERHUB_PASS | docker login --username $DOCKERHUB_USER --password-stdin
        - docker build --tag "$DOCKERHUB_USER/get-ninjas-api" .
        - docker push "$DOCKERHUB_USER/get-ninjas-api:latest"
      include:
    - stage: Terraform
      name: Plan
      env:
        - tf_version=1.1.4 
      install:
        - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        - unzip awscliv2.zip
        - sudo ./aws/install
        - wget https://releases.hashicorp.com/terraform/"$tf_version"/terraform_"$tf_version"_linux_amd64.zip
        - unzip terraform_"$tf_version"_linux_amd64.zip
        - sudo mv terraform /usr/local/bin/
        - rm terraform_"$tf_version"_linux_amd64.zip
      script:
        - cd terraform
        - terraform init
        - terraform plan
    - name: Apply
      script:
        - cd terraform
        - terraform init
        - terraform plan

